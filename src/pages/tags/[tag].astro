---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";
import PostCard from "../../components/PostCard.astro";

export async function getStaticPaths() {
    const allPosts = await getCollection("posts");
    const uniqueTags = [
        ...new Set(allPosts.flatMap((post) => post.data.tags || [])),
    ];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts
            .filter((post) => post.data.tags?.includes(tag) && !post.data.draft)
            .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Base
    title={`Posts tagged with "${tag}" | Mete Morris Blog`}
    description={`Browse articles tagged with ${tag} on Mete Morris' personal blog.`}
>
    <div class="space-y-10 mx-auto max-w-[65ch]">
        <section class="space-y-5 fade-in mt-6">
            <div
                class="flex items-center justify-between border-b border-[var(--page-border)] pb-4"
            >
                <p class="eyebrow">Tagged with: {tag}</p>
                <a
                    href="/blog"
                    class="text-xs uppercase tracking-[0.2em] text-[var(--page-muted)] hover:text-white transition-colors"
                >
                    View all posts
                </a>
            </div>

            <div class="space-y-5">
                {
                    posts.length === 0 && (
                        <p class="muted text-sm pt-4">
                            No posts found with this tag.
                        </p>
                    )
                }

                {
                    posts.map((entry) => (
                        <PostCard
                            slug={entry.slug}
                            title={entry.data.title}
                            description={entry.data.description}
                            date={entry.data.date}
                            body={entry.body}
                            showTags={false}
                            showReadingTime={true}
                        />
                    ))
                }
            </div>
        </section>
    </div>
</Base>
